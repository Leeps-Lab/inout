<link
    rel="import"
    href="/static/bower_components/polymer/polymer.html" />
<link
    rel="import"
    href="/static/webcomponents/inout/payout-graph.html" />

<link
    rel="import"
    href="/static/otree-redwood/webcomponents/redwood-period/redwood-period.html">

<dom-module id="in-out">
    <template>
        <style>
            #choice {
                font-weight: bold;
            }
            #text {
                text-align: center;
            }
            #buttons {
                text-align: center;
            }
           
        </style>

        <redwood-period>
        </redwood-period>


        <div id="text">
            <span id="choice">{{ _inGroup }}/1</span> <span id="static_text"> in your group chose</span> <span id="choice"> P</span>
        </div>
        <div id="text">
            Your current pay off is {{ _currentPayoff }}; cumlative is {{ _cumulativePayoff }}
        </div>
        <br>
        <payout-graph id="text"
            game-Constant='[[ c ]]'>
        </payout-graph>
        <div id="text">
            Your current choice is <span id="choice">{{ _choice }}</span>
        </div>
        <div id="text">
           You have <span id="choice">{{ _timeLeft }}s</span> to switch or stay
        </div>
        <br>
        <div id="buttons">
            <button
                type="button"
                value=true
                on-tap="_changeStatus"
                class="choiceButton">
                IN
            </button>
            <button
                type="button"
                value=false
                on-tap="_changeStatus"
                class="choiceButton">
                OUT
            </button>
        </div>
    </template>   
    
    <script>
        Polymer({
            is: 'in-out',
            properties: {
                isIn: {
                    type: Boolean,
                    value: true,
                },
                initialValue: {
                    type: Number,
                },
                a: {
                    type: Number,
                },
                s: {
                    type: Number,
                },
                c: {
                    type: Number,
                },
                treatment: {
                    type: String,
                },
                tickLength: {
                    type: Number,
                },
                _timeLeft: {
                    type: Number,
                    value: 60,
                },
                _timeDriftAdjustmentTick:{
                    type: Number,
                    value: 0
                },
                _timeDriftAdjustmentTimer:{
                    type: Number,
                    value: 0
                },
                _startingTime: {
                    type: Number,
                },
                _previousTimeTick: {
                    type: Number,
                },
                _previousTimeTimer: {
                    type: Number,
                },
                _choice: {
                    type: String,
                    value: 'Q',
                },
                _x_t: {
                    type: Number,
                },
                _noise: {
                    type: Number,
                },
                _inGroup:{
                    type: Number,
                    value: 0,
                },
                _currentPayoff: {
                    type: Number,
                    value: 0,
                },
                _cumulativePayoff: {
                    type: Number,
                    value: 0,
                },
                _wasSkipInData: {
                    type: Boolean,
                    value: false
                }
            },
            ready() {
                console.log("in-out.html");
                this.async(this._setStartingTime, 1);
                this.payoff_graph = this.$$('payout-graph');

                this._x_t = this.initialValue;
            },
            _setStartingTime() {
                this._startingTime = Date.now();

                this._previousTimeTick = (this._startingTime / 1000);
                this._previousTimeTimer = (this._startingTime / 1000);

                this._tick();
                this.timer = window.setTimeout(this._timeTick.bind(this), 1000);
            },
            _changeStatus(e){
                if(e.target.value === 'true'){
                    this.isIn = true;
                    this._inGroup = 1;
                    this._choice = "P"
                } else{
                    this.isIn = false;
                    this._inGroup = 0;
                    this._choice = "Q"
                }
            },
            _generateNoise() {
                noise1 = Math.random();
                noise2 = Math.random();

                this._noise = (noise1 + noise2)*(this.s);
            },
            _generateX_t() {

                this._generateNoise();

                this._x_t = ((this.a * this._x_t) + this._noise);

                this._x_t = parseFloat(this._x_t.toFixed(3));

            },
            _calculateTime() {
                tempNow = (Date.now() / 1000);
                tempBegin = (this._startingTime / 1000);
                timeNow = tempNow - tempBegin;


                return timeNow;
            },
            _calculateDrift(forTimer, currentTime){
                if(forTimer === true){
                    drift = (currentTime - this._previousTimeTimer);
                    this._timeDriftAdjustmentTimer = drift;

                    
                } else {
                    drift = (currentTime - this._previousTimeTick);
                    this._timeDriftAdjustmentTick = drift;
                    
                }
            },
            _timeTick() {
                currTime = (Date.now() / 1000);
                this._calculateDrift(true, currTime);
                this._previousTimeTimer = currTime;

                
                if(this._timeLeft > 0){
                    this._timeLeft = this._timeLeft - 1;

                    this.timer = window.setTimeout(this._timeTick.bind(this), (1000 - this._timeDriftAdjustmentTimer) );
                } else {
                    window.clearTimeout(this.timer);
                }


            },
            _tick() {
                index = this._calculateTime();
                index = Math.trunc(index);

                this._generateX_t();

                ifOutValue = (this.treatment.toLowerCase() === "u") ? null : this._x_t;

                if(this.isIn === true){
                    this._updateGraph([index, this._x_t]);
                    this._updatePayoff(this._x_t);

                    this._X_tGraph([index, this._x_t]);
                    
                } else {
                    this._updateGraph([index, this.c]);
                    this._updatePayoff(this.c);
                    this._X_tGraph([index, ifOutValue]);

                }


                currTime = (Date.now() / 1000);
                this._calculateDrift(false, currTime);
                this._previousTimeTick = currTime;
                if(timeNow > 60){
                    window.clearTimeout(this.timeout);
                    console.log("Killed");
                } else {
                    this.timeout = window.setTimeout(this._tick.bind(this), (this.tickLength - this._timeDriftAdjustmentTick) );
                }


            },
            _updateGraph(data) {
                this.payoff_graph.addPersonalData(data);
            },
            _updatePayoff(current){
                this._currentPayoff = current;
                this._cumulativePayoff = this._cumulativePayoff + current;
            },
            _X_tGraph(data){
                    this.payoff_graph.addX_tData(data);
            }

        });
    </script>

</dom-module>